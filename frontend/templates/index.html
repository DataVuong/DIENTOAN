<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ph√¢n T√≠ch C·∫£m X√∫c ·∫®m Th·ª±c</title>
    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <style>
      body {
        background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }
      .container {
        background: rgba(255,255,255,0.95);
        max-width: 1100px;
        margin: 60px auto 0 auto;
        border-radius: 18px;
        box-shadow: 0 8px 32px 0 rgba(31,38,135,0.2);
        padding: 32px 32px 24px 32px;
        text-align: center;
      }
      .nav {
        margin-bottom: 24px;
        text-align: center;
      }
      .nav button {
        background: linear-gradient(90deg, #43c6ac 0%, #191654 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 20px;
        font-size: 1rem;
        cursor: pointer;
        margin: 0 8px 12px 8px;
        transition: background 0.3s;
      }
      .nav button:hover {
        background: linear-gradient(90deg, #191654 0%, #43c6ac 100%);
      }
      h2 {
        color: #43c6ac;
        margin-bottom: 18px;
      }
      button {
        background: linear-gradient(90deg, #43c6ac 0%, #191654 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 24px;
        font-size: 1rem;
        cursor: pointer;
        margin: 8px 0;
        transition: background 0.3s;
      }
      button:hover {
        background: linear-gradient(90deg, #191654 0%, #43c6ac 100%);
      }
      #userEmail {
        color: #191654;
        font-size: 0.95rem;
        margin-bottom: 10px;
        display: block;
      }
      .foods-row {
        display: flex;
        flex-wrap: wrap;
        gap: 32px;
        justify-content: center;
        margin-bottom: 24px;
      }
      .food-card {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(67,198,172,0.08);
        width: 200px;
        padding: 18px 14px 16px 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .food-card img {
        max-width: 100%;
        border-radius: 12px;
        margin-bottom: 10px;
        height: 120px;
        object-fit: cover;
      }
      .food-card h3 {
        margin: 0 0 8px 0;
        color: #43c6ac;
        font-size: 1.1rem;
      }
      .food-card textarea {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #43c6ac;
        padding: 8px;
        font-size: 1rem;
        margin-bottom: 8px;
        resize: vertical;
        min-height: 60px;
        box-sizing: border-box;
      }
      .food-card .result {
        margin-top: 6px;
        font-weight: bold;
        color: #191654;
        font-size: 1rem;
        min-height: 20px;
      }
    </style>
    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDXbd55DJxke51WPOtGR4kTBowk1WydxuU",
        authDomain: "sentiment-system-18601.firebaseapp.com",
        projectId: "sentiment-system-18601",
        appId: "1:1042399836905:web:3d5aa82aef28e3e3d88e78",
      };
      firebase.initializeApp(firebaseConfig);

      let idToken = "";
      const foods = [
        { name: "Ph·ªü B√≤", img: "/static/phobo.jpg" },
        { name: "B√∫n Ch·∫£", img: "/static/buncha.jpg" },
        { name: "B√°nh M√¨", img: "/static/banhmi.png" },
        { name: "G·ªèi Cu·ªën", img: "/static/goicuon.jpg" },
        { name: "C∆°m T·∫•m", img: "/static/comtam.jpg" },
        {name: "B√≤ B√≠t T·∫øt",img: "/static/bobittet.jpg"}
      ];
      let reviewedFoods = {}; // L∆∞u tr·∫°ng th√°i ƒë√£ ƒë√°nh gi√° trong session

      function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then((result) => {
          result.user.getIdToken().then((token) => {
            idToken = token;
            alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
            document.getElementById("userEmail").innerText = result.user.email;
            reviewedFoods = {};
          });
        });
      }

      function logout() {
        firebase.auth().signOut().then(() => {
          idToken = "";
          alert("ƒê√£ ƒëƒÉng xu·∫•t!");
          document.getElementById("userEmail").innerText = "";
          reviewedFoods = {};
        });
      }

      function submitReview(idx) {
        const text = document.getElementById(`reviewText_${idx}`).value;
        const foodName = foods[idx].name;
        if (!idToken) {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi g·ª≠i ƒë√°nh gi√°!");
          return;
        }
        if (reviewedFoods[foodName]) {
          alert("B·∫°n ch·ªâ ƒë∆∞·ª£c ƒë√°nh gi√° m·ªói m√≥n ƒÉn m·ªôt l·∫ßn trong m·ªói l·∫ßn ƒëƒÉng nh·∫≠p!");
          return;
        }
        fetch("/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": idToken
          },
          body: JSON.stringify({ text, food: foodName })
        })
        .then(res => res.json())
        .then(data => {
          document.getElementById(`result_${idx}`).innerText = "C·∫£m x√∫c: " + (data.sentiment || data.error);
          reviewedFoods[foodName] = true;
        });
      }

      window.onload = function() {
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            document.getElementById("loginBtn").style.display = "none";
            document.getElementById("logoutBtn").style.display = "inline-block";
            document.getElementById("userEmail").innerText = user.email;
            user.getIdToken().then(token => { idToken = token; });
          } else {
            document.getElementById("loginBtn").style.display = "inline-block";
            document.getElementById("logoutBtn").style.display = "none";
            document.getElementById("userEmail").innerText = "";
            idToken = "";
            reviewedFoods = {};
          }
        });
        // Render c√°c m√≥n ƒÉn
        const foodsRow = document.getElementById("foodsRow");
        foodsRow.innerHTML = "";
        foods.forEach((food, idx) => {
          foodsRow.innerHTML += `
            <div class="food-card">
              <img src="${food.img}" alt="${food.name}">
              <h3>${food.name}</h3>
              <textarea id="reviewText_${idx}" placeholder="Nh·∫≠p ƒë√°nh gi√° c·ªßa b·∫°n..."></textarea>
              <button onclick="submitReview(${idx})">G·ª≠i ƒë√°nh gi√°</button>
              <div class="result" id="result_${idx}"></div>
            </div>
          `;
        });
      };
    </script>
</head>
<body>
    <div class="container">
      <div class="nav">
        <button onclick="window.location.href='/'">Trang ch·ªß</button>
        <button onclick="window.location.href='/admin'">Qu·∫£n l√Ω ƒë√°nh gi√°</button>
        <button onclick="window.location.href='/stats'">Th·ªëng k√™ c·∫£m x√∫c</button>
      </div>
      <h2>üç≤ Ph√¢n T√≠ch C·∫£m X√∫c ·∫®m Th·ª±c üç≤</h2>
      <span id="userEmail"></span>
      <button id="loginBtn" onclick="loginWithGoogle()">ƒêƒÉng nh·∫≠p Google</button>
      <button id="logoutBtn" onclick="logout()" style="display:none;">ƒêƒÉng xu·∫•t</button>
      <div class="foods-row" id="foodsRow"></div>
    </div>
</body>
</html>
